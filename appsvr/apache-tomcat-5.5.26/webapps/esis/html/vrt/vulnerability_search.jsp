<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<!-- the HTML header allows us to view the jsp as an html file in web browsers -->
<%--
  -- ESIS
  --
  -- Copyright (c) 2004-2008 Entelience SARL,  Copyright (c) 2008-2009 Equity SA
  --
  -- Projects contributors : Philippe Le Berre, Thomas Burdairon, Benjamin Baudel,
  --                         Benjamin S. Gould, Diego Patinos Ramos, Constantin Cornelie
  -- 
  -- This file is part of ESIS.
  --
  -- ESIS is free software: you can redistribute it and/or modify
  -- it under the terms of the GNU General Public License as published by
  -- the Free Software Foundation version 3 of the License.
  --
  -- ESIS is distributed in the hope that it will be useful,
  -- but WITHOUT ANY WARRANTY; without even the implied warranty of
  -- MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
  -- GNU General Public License for more details.
  --
  -- You should have received a copy of the GNU General Public License
  -- along with ESIS.  If not, see <http://www.gnu.org/licenses/>.
  --
  -- $Id: vulnerability_search.jsp 11 2009-07-07 15:02:53Z tburdairon $
  --
  --%>
<%@ page import="com.entelience.soap.soapVulnerabilityReview" %>
<%@ page import="com.entelience.objects.vrt.SearchedVulnerabilityInfoLine" %>
<%@ page import="com.entelience.sql.DbHelper" %>
<%@ page import="java.util.HashMap" %>
<%@ page import="java.util.Map" %>
<%@ page import="java.util.List" %>
<%@ page import="java.util.ArrayList" %>
<%@ page import="java.util.regex.Pattern" %>

<%@ page extends="com.entelience.servlet.JspBase" %>
<%!
	// Class declarations
	
	private static final Pattern p_comma = Pattern.compile(",");
	
    public void initLabels() {
	   labels = new HashMap<String, String>();
	   labels.put("VULN_SEARCH_en", "Vulnerabilities Search ");
	   labels.put("NO_VULNS_FOUND_en", "No Vulnerability found");
	   labels.put("ERROR_PARAMS_en", "Parameters error for JSP");
	   labels.put("SEARCH_en", "Searched text");

	   labels.put("VULN_SEARCH_fr", "Recherche de vuln&eacute;rabilit&eacute;s ");
	   labels.put("NO_VULNS_FOUND_fr", "Aucune vuln&eacute;rabilit&eacute; trouv&eacute;e");
	   labels.put("ERROR_PARAMS_fr", "Erreur dans les param&egrave;tres de la JSP");
	   labels.put("SEARCH_fr", "Texte recherch&eacute;");
	}
	
	Map<String, String> labels;
	String language;
	
	public String getLabel(String key) {
		String langKey=key+"_"+language;
		String res = labels.get(langKey);
		if(res==null)
			res=labels.get(key+"_en");
		if(res==null)
			res=key;
		return res;
	}
	
	// end class declarations
%>
<%
try{
	// code
	// Check session id validity
	Integer peopleId = getSession(request);
	initTimeZone(peopleId);
	
	language = getParam(request,"lang");
	if(language == null || language.length()==0)
		language = "en";
	initLabels();
	
	String searchedText = getParam(request, "searched_text");
	
	String searchType = getParam(request, "search_type");
	if(searchType == null || searchType.length() == 0){
		throw new Exception("Null parameter : search_type");
	}
	String categoryFilter =getParam( request,"category_filter");
	String matches = getParam(request, "matches");
	String raciMatch = getParam(request, "raciMatch");
	
	List<Number> matchArray = new ArrayList<Number>();
	
	if(DbHelper.nullify(matches) != null){
	    String[] tmp = p_comma.split(matches);
	    for(int i=0; i< tmp.length; i++){
		matchArray.add(Integer.valueOf(tmp[i]));
	    }
	}
	
	if(categoryFilter == null) categoryFilter = "";
	if(matches == null) matches = "";

	Integer pageNumber = getParamInteger(request, "page");
	String order = getParam(request, "order");
	Boolean my = getParamBoolean(request, "my");
	
	// Now we can use webservices
	soapVulnerabilityReview vr = new soapVulnerabilityReview(peopleId);
	
	SearchedVulnerabilityInfoLine resultSearch[] = vr.findVulnerabilities(searchedText, searchType, categoryFilter, matchArray, raciMatch, order, pageNumber, my);
	// end code
%>
<head>
<title><%= getLabel("VULN_SEARCH")%></title>
<%@ include file="../style.inc.jsp" %>
</head>
<body>
<table width="100%" border="0" align="center" bgcolor="white">
<tr>
	<td>
	<div align="center">
	<!-- Header //-->
	<table border="0" align="center" cellspacing="0" cellpadding="4" width="100%">
	<tr>
		<td width="20%" rowspan="2" align="left"><a href="http://esis.sourceforge.net/" target="_blank"><%@ include file="../icon.inc.jsp" %></a></td>
		<td width="80%" align="center" class="title"><%= getLabel("VULN_SEARCH")%></td>
	</tr>
	<tr>
		<td align="center" class="subtitle"><%= searchedText%></td>
	</tr>
	</table>
	<br/>
	<!-- search infos -->
	<br/>
	<table border="1" cellspacing="0" cellpadding="4" width="90%">
	<tr>
		<td align="center" width="30%" bgcolor="gainsboro"><%= getLabel("SEARCH")%></td>
		<td align="center" width="70%"><b><%= searchedText %></b> in <%= searchType %></td>
	</tr>
	</table>
	<br/>
	<!-- search results -->
	<%
	if (resultSearch == null || resultSearch.length == 0) {
	%>
	<!-- no Vulns -->
	<br/>
	<table border="1" cellspacing="0" cellpadding="4" width="90%">
	<tr>
		<td align="center"><%= getLabel("NO_VULNS_FOUND")%></td>
	</tr>
	</table>
	<%
	} else {
	// results
	%>
	<br/>
	<table border="1" cellspacing="0" cellpadding="4" width="90%">
	<tr>
		<td width="25%" align="center" bgcolor="gainsboro"><b>Vulnerability</b></td>
		<td width="25%" align="center" bgcolor="gainsboro"><b>Decision</b></td>
		<td width="25%" align="center" bgcolor="gainsboro"><b>Status</b></td>
		<td width="25%" align="center" bgcolor="gainsboro"><b>Published date</b></td>
	</tr>
	<%
	for(int i=0; i<resultSearch.length; i++){
	%>
	<tr>
		<td width="25%" align="center"><b><%= resultSearch[i].getVulnName() %></b></td>
		<td width="25%" align="center"><%= resultSearch[i].getDecision() %></td>
		<td width="25%" align="center"><%= resultSearch[i].getStatus() %></td>
		<td width="25%" align="center"><%= formatDate(resultSearch[i].getPublishDate()) %></td>
	</tr>
	<tr>
		<td colspan="4" align="left"><%= HTMLTitle(resultSearch[i].getDescription(), null) %></td>
	</tr>
	<tr>
		<td colspan="2" align="center">Vendor(s): <%= resultSearch[i].getVendor() == null ? "&nbsp;" : resultSearch[i].getVendor().replaceAll("\\n", ",&nbsp; ")%></td>
		<td colspan="2" align="center">Product(s): <%= resultSearch[i].getProduct() == null ? "&nbsp;" : resultSearch[i].getProduct().replaceAll("\\n", ",&nbsp; ") %></td>
	</tr>
	<tr>
		<td colspan="4" bgcolor="gainsboro">&nbsp;</td>
	</tr>
	<%
	}//end for
	%>
	</table>
	<%
	}// end if
	%>
	<%@ include file="../copyright.inc.jsp" %>
	</div>
	</td>
</tr>
</table>
</body>
</html>
<%
} catch(Exception e){
	_logger.error("Exception during JSP execution", e);
	setErrorMessage(response, e, getSessionId(request));
}
%>